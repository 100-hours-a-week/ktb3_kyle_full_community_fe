<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>게시글 작성</title>
    <link rel="stylesheet" href="/src/pages/styles/post-create.css"/>
    <link rel="stylesheet" href="/src/pages/styles/header.css"/>
    <link rel="stylesheet" href="/src/components/styles/image-container.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
</head>
<body>
<div id="header"></div>
<div class="post-container">
    <h2 class="post-title">게시글 작성</h2>

    <!-- 제목 -->
    <div class="form-group">
        <label class="label-text">제목*</label>
        <input id="title" type="text" class="input-title" maxlength="26" placeholder="제목을 입력해주세요. (최대 26글자)">
    </div>

    <!-- 내용 -->
    <div class="form-group">
        <label class="label-text">내용*</label>
        <textarea id="content" class="input-content" placeholder="내용을 입력해주세요."></textarea>
        <p id="helper" class="helper-text">제목, 내용을 모두 작성해주세요.</p>
    </div>

    <!-- 이미지 -->
    <div id="image-container"></div>

    <!-- 완료 버튼 -->
    <button id="submit" class="submit-btn" disabled>완료</button>
</div>
<script type="module">
    import { API_BASE_URL } from "../utils/config.js";
    import { Dropdown } from "../utils/Dropdown.js";
    import { ImageContainer } from "../components/ImageContainer.js";
    import { Image } from "../components/Image.js";

    const inputState = {
        title: "",
        content: "",
        images: []
    };

    document.getElementById("image-container").innerHTML = ImageContainer();

    const submit = document.getElementById("submit");
    submit.onclick = async () => {
        const result = await createPost(inputState);
        if (result === true) {
            location.href = "http://localhost:3000/src/pages/post-list.html";
        }
    }

    const imageInput = document.getElementById("image-input");
    imageInput.onclick = () => imageUpload.click();

    const imageUpload = document.getElementById("image-upload");
    imageUpload.onchange = (event) => {
        const newImages = Array.from(event.target.files);
        showSelectedImages(newImages);
        if (newImages.length !== 0) inputState["images"] = newImages;
    }

    const removeSelectedImage = (indexToRemove) => {
        inputState["images"] = inputState.images.filter((_, index) => index !== indexToRemove);
        showSelectedImages(inputState.images);
    }

    const showSelectedImages = async (images) => {
        const promises = images.map((image, index) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve(Image({ id: index, url: e.target.result }));
                };
                reader.readAsDataURL(image);
            })
        })

        const imageList = await Promise.all(promises);
        document.getElementById("image-list").innerHTML = imageList.join("");

        const cancelButtons = document.querySelectorAll(".image-cancel");
        cancelButtons.forEach((button, index) => {
            button.onclick = () => removeSelectedImage(index);
        });
    }

    const createPost = ({ title, content }) => {
        const formData = new FormData();
        formData.append(
            "request",
            new Blob([JSON.stringify({
                title: title,
                content: content
            })], { type: "application/json" })
        );

        Object.values(inputState.images).forEach(image => formData.append("images", image));
        console.log(inputState);

        console.log(formData.get("images"));

        return fetch(`${API_BASE_URL}/posts/image`, {
            method: "POST",
            credentials: "include",
            body: formData
        })
            .then(res => res.json())
            .then(json => json.success)
    }

    const checkInputState = () => {
        const title = inputState.title;
        const content = inputState.content;
        return title.length !== 0 && content.length !== 0;
    }

    const applyBlurEvent = (inputId) => {
        const input = document.getElementById(inputId);
        const helper = document.getElementById("helper");

        input.addEventListener('blur', async () => {
            inputState[inputId] = input.value;
            const submitButton = document.querySelector(".submit-btn");
            const result = checkInputState();
            submitButton.classList.toggle("valid", result);
            submitButton.disabled = !result;
            helper.classList.toggle("valid", result);
            helper.innerText = result ? "작성 완료" : "제목, 내용을 모두 입력해주세요.";
        })
    }

    applyBlurEvent("title");
    applyBlurEvent("content");

    fetch("/src/components/header.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("header").innerHTML = data;
            Dropdown();
        });
</script>
</body>
</html>