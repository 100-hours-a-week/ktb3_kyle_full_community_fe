<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>비밀번호 수정</title>
    <link rel="stylesheet" href="styles/password-update.css"/>
    <link rel="stylesheet" href="styles/header.css"/>
</head>
<body>
<div id="header"></div>
<div class="container">
    <div class="password-box">
        <h2 class="edit-title">비밀번호 수정</h2>

        <div class="input-wrapper"> <!-- 392 x 221을 감싸는 div -->
            <label for="password">비밀번호</label>
            <input type="password" id="password" placeholder="비밀번호를 입력하세요"/>
            <p id="password-helper" class="helper-text">비밀번호를 입력해주세요.</p>

            <label for="password-check">비밀번호 확인</label>
            <input type="password" id="password-check" placeholder="비밀번호를 한번 더 입력하세요"/>
            <p id="password-check-helper" class="helper-text">* 비밀번호를 한번 더 입력해주세요.</p>
        </div>

        <button id="edit-button" class="edit-btn" disabled>수정하기</button> <!-- 383 x 37 -->

        <div id="toast" class="toast">수정완료</div>
    </div>
</div>

<script type="module">
    import api from "../utils/Api.js";
    import { Dropdown } from "../utils/Dropdown.js";

    const inputState = {
        password: {
            value: "", valid: false
        },
        passwordCheck: {
            value: "", valid: false
        }
    }

    const edit = document.getElementById("edit-button");
    edit.onclick = () => {
        api.patch(`/users/password`, {
            password: inputState.password.value
        })
            .then((res) => {
                if (res.ok) {
                    const toast = document.getElementById("toast");
                    toast.classList.add("show");

                    setTimeout(() => {
                        toast.classList.remove("show");
                    }, 2000);
                }
            })
    }

    const validationPassword = (passwordValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const passwordState = inputState['password'];

        if (passwordValue.length <= 0) {
            passwordState['valid'] = false;
            return fail("*비밀번호를 입력해주세요");
        }

        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[~!@#$%^&*(),.?":{}|<>])[A-Za-z\d~!@#$%^&*(),.?":{}|<>]{8,20}$/;
        if (!passwordRegex.test(passwordValue)) {
            passwordState['valid'] = false;
            return fail("*비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야합니다.");
        }

        passwordState['valid'] = true;
        passwordState['value'] = passwordValue;
        return success("");
    }

    const passwordDoubleCheck = (passwordCheckValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const passwordCheckState = inputState['passwordCheck'];

        if (passwordCheckValue <= 0) {
            passwordCheckState['valid'] = false;
            return fail("*비밀번호를 한번 더 입력해주세요.");
        }

        const password = document.getElementById("password");
        if (password.value !== passwordCheckValue) {
            passwordCheckState['valid'] = false;
            return fail("*비밀번호가 다릅니다.");
        }

        passwordCheckState['valid'] = true;
        passwordCheckState['value'] = passwordCheckValue;
        return success("*비밀번호가 일치합니다.");
    }

    const updateHelperText = (helper, { pass, message }) => {
        helper.innerText = message;
        helper.classList.toggle("valid", pass);
    }

    const checkInputState = () => {
        return Object.values(inputState).every(field => field.valid === true);
    }

    const applyBlurEvent = (inputId, helperId, validation) => {
        const input = document.getElementById(inputId);
        const helper = document.getElementById(helperId);

        input.onblur = async () => {
            const result = await validation(input.value);
            updateHelperText(helper, result);

            if (checkInputState()) {
                const editButton = document.querySelector(".edit-btn");
                editButton.classList.add("valid");
                editButton.disabled = false;
            }

            if (inputId === "password") {
                const passwordCheck = document.getElementById("password-check");
                passwordCheck.focus();
                passwordCheck.blur();
            }
        }
    }

    applyBlurEvent("password", "password-helper", validationPassword);
    applyBlurEvent("password-check", "password-check-helper", passwordDoubleCheck);

    fetch("/src/components/header.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("header").innerHTML = data;
            Dropdown();
        });
</script>
</body>
</html>
