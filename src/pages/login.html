<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>로그인</title>
    <link rel="stylesheet" href="styles/login.css"/>
    <link rel="stylesheet" href="styles/header.css"/>
    <link rel="stylesheet" href="/src/components/styles/toast.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

</head>
<body>
<div id="header"></div>
<div class="container">
    <div class="login-box">
        <h2 class="login-title">로그인</h2>

        <div class="input-wrapper">
            <div id="email-input"></div>
            <div id="password-input"></div>
        </div>

        <div style="position: relative">
            <button id="login-button" class="login-btn" disabled>로그인</button>
            <div id="toast-container"></div>
        </div>

        <button class="signup-btn" onclick="location.href = `http://localhost:3000/src/pages/signup.html`">회원가입</button>
        <!-- 68 x 30 -->
    </div>
</div>

<script type="module">
    import api from "../utils/Api.js";
    import { Toast } from "../components/Toast.js";
    import { Input } from "../components/Input.js";

    const toastContainer = document.getElementById("toast-container");
    toastContainer.innerHTML = Toast();

    document.getElementById("email-input").innerHTML = Input({
        label: "이메일",
        inputId: "email",
        type: "text",
        placeholder: "이메일을 입력하세요",
        helperId: "email-helper",
        helperText: ""
    });

    document.getElementById("password-input").innerHTML = Input({
        label: "비밀번호",
        inputId: "password",
        type: "password",
        placeholder: "비밀번호를 입력하세요",
        helperId: "password-helper",
        helperText: ""
    });

    const inputState = {
        email: {
            value: "", valid: false
        },
        password: {
            value: "", valid: false
        }
    }

    const validationEmail = async (emailValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const emailState = inputState['email'];

        if (emailValue.length <= 0) {
            emailState['valid'] = false;
            return fail("올바른 이메일 주소 형식을 입력해주세요");
        }

        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i;
        if (!emailRegex.test(emailValue)) {
            emailState['valid'] = false;
            return fail("올바른 이메일 주소 형식을 입력해주세요");
        }

        emailState['valid'] = true;
        emailState['value'] = emailValue;
        return success("");
    }

    const authenticate = ({ email, password }) => {
        return api.post(`/auth/sessions`, {
            email: email.value,
            password: password.value
        })
            .then(res => res.json())
            .then(json => json.success)
    }

    const login = document.getElementById("login-button");
    login.onclick = async () => {
        const result = await authenticate(inputState);
        if (result === true) {
            location.href = "http://localhost:3000/src/pages/post-list.html";
        } else {
            updateHelperText("password-helper", { pass: false, message: "아이디 또는 비밀번호를 확인해주세요" })
        }
    }

    const validationPassword = (passwordValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const passwordState = inputState['password'];

        if (passwordValue.length <= 0) {
            passwordState['valid'] = false;
            return fail("비밀번호를 입력해주세요");
        }

        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[~!@#$%^&*(),.?":{}|<>])[A-Za-z\d~!@#$%^&*(),.?":{}|<>]{8,20}$/;
        if (!passwordRegex.test(passwordValue)) {
            passwordState['valid'] = false;
            return fail("비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야합니다");
        }

        passwordState['valid'] = true;
        passwordState['value'] = passwordValue;
        return success("");
    }

    const updateHelperText = (helper, { pass, message }) => {
        //helper.innerText = message;
        // toastContainer.innerHTML = Toast(message);
        const toast = document.querySelector(".toast");
        const toastMessage = document.getElementById("toast-message");
        toast.classList.toggle("active", !pass);
        toastMessage.innerText = message;
        setTimeout(() => {
            toast.classList.remove("active");
        }, 2000);
    }

    const checkInputState = () => {
        return Object.values(inputState).every(field => field.valid === true);
    }

    const applyBlurEvent = (inputId, helperId, validation) => {
        const input = document.getElementById(inputId);
        const helper = document.getElementById(helperId);

        input.addEventListener('blur', async () => {
            const result = await validation(input.value);
            updateHelperText(helper, result);
            if (checkInputState()) {
                const loginButton = document.querySelector(".login-btn");
                loginButton.classList.add("valid")
                loginButton.disabled = false;
            }
        })
    }

    applyBlurEvent("email", "email-helper", validationEmail);
    applyBlurEvent("password", "password-helper", validationPassword);

    const inputBoxes = document.querySelectorAll(".input-box");
    inputBoxes.forEach(box => {
        const input = box.querySelector("input");
        input.onfocus = () => box.classList.add("focus");
        input.onblur = () => box.classList.remove("focus");
    })

    fetch("/src/components/header.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("header").innerHTML = data;
            const headerProfile = document.querySelector(".header-profile-container");
            headerProfile.classList.add("disable");
        });
</script>
</body>
</html>
