<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>회원가입</title>
    <link rel="stylesheet" href="/src/pages/styles/signup.css"/>
    <link rel="stylesheet" href="/src/pages/styles/header.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
</head>
<body>
<div id="header"></div>
<div class="container">
    <div class="signup-box">
        <h2 class="signup-title">회원가입</h2>

        <div class="input-wrapper">
            <label for="email">프로필 사진</label>
            <p id="image-helper" class="helper-text">프로필 사진을 추가해주세요.</p>
            <div class="image-wrapper">
                <div class="image-upload">
                    <input id="profile" type="file" accept="image/*" hidden>
                </div>
            </div>

            <label for="email">이메일*</label>
            <div class="input-box">
                <input type="text" id="email" placeholder="이메일을 입력하세요"/>
                <div id="email-helper" class="helper-text">이메일을 입력해주세요.</div>
            </div>

            <label for="password">비밀번호*</label>
            <div class="input-box">
                <input type="password" id="password" placeholder="비밀번호를 입력하세요"/>
                <p id="password-helper" class="helper-text">비밀번호를 입력해주세요.</p>
            </div>

            <label for="password-check">비밀번호 확인*</label>
            <div class="input-box">
                <input type="password" id="password-check" placeholder="비밀번호를 한번 더입력하세요"/>
                <p id="password-check-helper" class="helper-text">비밀번호를 한번 더 입력해주세요.</p>
            </div>

            <label for="nickname">닉네임*</label>
            <div class="input-box">
                <input type="text" id="nickname" placeholder="닉네임을 입력하세요"/>
                <p id="nickname-helper" class="helper-text">닉네임을 입력해주세요.</p>
            </div>
        </div>

        <button id="signup-button" class="signup-btn" disabled>회원가입</button>

        <button class="login-btn" onclick="location.href = `http://localhost:3000/src/pages/login.html`">로그인하러 가기
        </button>
    </div>
</div>

<script type="module">
    import { API_BASE_URL } from "../utils/config.js";
    import { Dropdown } from "../utils/Dropdown.js";
    import api from "../utils/Api.js";

    const inputState = {
        email: {
            value: "", valid: false
        },
        password: {
            value: "", valid: false
        },
        nickname: {
            value: "", valid: false
        },
        profileImage: {
            value: "kyle.png", valid: true
        },
    }

    const imageUploader = document.getElementById('profile')
    const imageBox = document.querySelector('.image-upload')
    imageBox.addEventListener('click', () => imageUploader.click())

    imageUploader.onchange = (event) => {
        const image = event.target.files[0];
        const helper = document.getElementById("image-helper");

        if (!image) {
            imageBox.classList.remove("has-image");
            helper.classList.remove("valid");
            helper.innerText = "프로필 사진을 추가해주세요.";
            imageBox.style.backgroundImage = `none`;
            return;
        }

        inputState["profileImage"]["value"] = image;

        const reader = new FileReader();
        reader.onload = (e) => {
            imageBox.style.backgroundImage = `url(${e.target.result})`; // 이미지 표시
        }
        reader.readAsDataURL(image);
        imageBox.classList.add('has-image');

        helper.classList.add("valid");
        helper.innerText = "프로필 사진이 추가되었습니다.";
    }

    const checkEmailDuplicate = (email) => {
        return fetch(`${API_BASE_URL}/users/email/duplicate?email=${email}`)
            .then(res => res.json())
            .then(json => json.data);
    }

    const checkNicknameDuplicate = (nickname) => {
        return fetch(`${API_BASE_URL}/users/nickname/duplicate?nickname=${nickname}`)
            .then(res => res.json())
            .then(json => json.data);
    }

    const createUser = ({ email, password, nickname, profileImage }) => {
        const formData = new FormData();
        formData.append(
            "request",
            new Blob([JSON.stringify({
                email: email.value,
                password: password.value,
                nickname: nickname.value,
                profileImage: profileImage.value,
            })], { type: "application/json" })
        );
        console.log(inputState.profileImage.value)
        formData.append("image", inputState.profileImage.value);

        return api.post(`/users`, formData)
            .then(res => res.json())
            .then(json => json.success)
    }

    const signup = document.getElementById("signup-button");
    signup.onclick = async () => {
        const result = await createUser(inputState);
        if (result === true) {
            location.href = "http://localhost:3000/src/pages/login.html";
        }
    }

    const validationEmail = async (emailValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const emailState = inputState['email'];

        if (emailValue.length <= 0) {
            emailState['valid'] = false;
            return fail("이메일을 입력해주세요.");
        }

        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i;
        if (!emailRegex.test(emailValue)) {
            emailState['valid'] = false;
            return fail("올바른 이메일 주소 형식을 입력해주세요.");
        }

        const duplicate = await checkEmailDuplicate(emailValue);
        if (duplicate) {
            emailState['valid'] = false;
            return fail("중복된 이메일 입니다.")
        }

        emailState['valid'] = true;
        emailState['value'] = emailValue;
        return success("사용 가능한 이메일입니다.");
    }

    const validationPassword = (passwordValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });

        if (passwordValue.length <= 0) {
            return fail("비밀번호를 입력해주세요");
        }

        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[~!@#$%^&*(),.?":{}|<>])[A-Za-z\d~!@#$%^&*(),.?":{}|<>]{8,20}$/;
        if (!passwordRegex.test(passwordValue)) {
            return fail("비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야합니다.");
        }

        return success("사용 가능한 비밀번호입니다.");
    }

    const passwordDoubleCheck = (passwordCheckValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const passwordState = inputState['password'];

        if (passwordCheckValue <= 0) {
            passwordState['valid'] = false;
            return fail("비밀번호를 한번 더 입력해주세요.");
        }

        const password = document.getElementById("password");
        if (password.value !== passwordCheckValue) {
            passwordState['valid'] = false;
            return fail("비밀번호가 다릅니다.");
        }

        passwordState['valid'] = true;
        passwordState['value'] = passwordCheckValue;
        return success("비밀번호가 일치합니다.");
    }

    const validationNickname = async (nicknameValue) => {
        const success = (message) => ({ pass: true, message: message });
        const fail = (message) => ({ pass: false, message: message });
        const nicknameState = inputState['nickname'];

        if (nicknameValue.length <= 0) {
            nicknameState['valid'] = false;
            return fail("닉네임을 입력해주세요.");
        }

        if (nicknameValue.length > 10) {
            nicknameState['valid'] = false;
            return fail("닉네임은 최대 10자까지 작성 가능합니다.");
        }

        if (nicknameValue.includes(' ')) {
            nicknameState['valid'] = false;
            return fail("띄어쓰기를 없애주세요.");
        }

        const duplicate = await checkNicknameDuplicate(nicknameValue);
        if (duplicate) {
            nicknameState['valid'] = false;
            return fail("중복된 닉네임 입니다.")
        }

        nicknameState['valid'] = true;
        nicknameState['value'] = nicknameValue;
        return success("사용 가능한 닉네임입니다.");
    }

    const updateHelperText = (helper, { pass, message }) => {
        helper.classList.toggle("valid", pass)
        helper.innerText = message;
    }

    const checkInputState = () => {
        return Object.values(inputState).every(field => field.valid === true);
    }

    const applyBlurEvent = (inputId, helperId, validation) => {
        const input = document.getElementById(inputId);
        const helper = document.getElementById(helperId);

        input.addEventListener('blur', async () => {
            const result = await validation(input.value);
            updateHelperText(helper, result);
            if (checkInputState()) {
                const signupButton = document.querySelector(".signup-btn");
                signupButton.classList.add("valid")
                signupButton.disabled = false;
            }

            // FIXME: 어떻게 수정할지 생각
            if (inputId === "password") {
                const passwordCheck = document.getElementById("password-check");
                passwordCheck.focus();
                passwordCheck.blur();
            }
        })
    }

    applyBlurEvent("email", "email-helper", validationEmail);
    applyBlurEvent("password", "password-helper", validationPassword);
    applyBlurEvent("password-check", "password-check-helper", passwordDoubleCheck);
    applyBlurEvent("nickname", "nickname-helper", validationNickname);

    const inputBoxes = document.querySelectorAll(".input-box");
    inputBoxes.forEach(box => {
        const input = box.querySelector("input");
        input.onfocus = () => box.classList.add("focus");
        input.onblur = () => box.classList.remove("focus");
    })

    fetch("/src/components/header.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("header").innerHTML = data;
            const headerProfile = document.querySelector(".header-profile-container");
            headerProfile.classList.add("disable");
        });
</script>
</body>
</html>
